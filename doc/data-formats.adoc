= Delectus 2 Data Formats
mikel evins
:toc:

== Terminology

[cols="1,4",options="header"]
.Terminology used in this manual
|===
| term |  definition
| *column* | A named collection of *fields* with shared attributes from all *items* in a *list*, stored as a column in a SQLite table.
| *identity* |  A unique identification of some object, distinct from all others. Delectus uses identities for *nodes*, *lists*, *ops*, and other objects it works with. It represents an *identity* using the `identity` datatype.
| *field* | A container for a *value* occupying a single *column* of an *item*.
| *item* | An individual, user-created entry in a list, stored as a row in a SQLite table.
| *list* |  A Delectus document containing data organized in rows and columns, one *item* to each row, and one *field* to each column. An item is a collection of fields; a list is a collection of items. Delectus stores each list in its own SQLite file, along with some associated *metadata*.
| *metadata* and *userdata* | *Userdata* is the information that users create and store in Delectus lists. *Metadata* is information that Delectus automatically creates and stores alongdie the userdata, in order to support application features. For example, when you add the item "milk" to a shopping list, the text "milk" is *userdata*; the timestamp recorded when you save the item is *metadata*.
| *node* | A Delectus process running on a specific user account on a specific device. Delectus assigns a distinct *identity* to each node, and records the `identity` of the node that writes each *op* in a list file.
| *op* |  A structure in a list file that represents an update to the state of the list. Delectus list data is represented as a time-ordered append-only log of ops.
|===


== Delectus data types

=== Metadata and userdata

Delectus represents *metadata* using SQLite `NULL`, `NUMBER`, and `TEXT values.`

Delectus represents *userdata* using JSON values stored as `TEXT`.

[cols="1,2,5",options="header"]
.Data types in ops and op messages
|===
| type name | Metadata or Userdata |  description
| `Boolean` | userdata |  JSON `true`, `false`, or `null`. `null` is treated as `false`.
| `column` | userdata | A JSON object that defines a column's attributes. See the `<<column-definition>>` definition, below.
| `field` | userdata | A *value* container in a *userdata* column. Fields contain JSON values.
| `identity` | metadata | A globally unique string derived from a v1 UUID, used in Delectus to uniquely identify certain types of objects, including *nodes*, *lists*, *ops*, *columns*, and *items*.
| `number` | metadata and userdata | Any JSON number.
| `sort-order` | userdata | `null`, `'ASC'`, or `'DESC'`. Specifies whether a column is the list's sort column, and if so, which direction to sort.
| `string` | metadata and userdata | A text string.
| `timestamp` | metadata | An ISO-8601 time string.
| `value` | userdata | JSON `null`, `'boolean'`, `'number'`, or `'string'`. Specifies the types of values the user expects a column to contain.
|===

=== `column` [[column-definition, column]]

A `column` is a JSON object of the following form:

[JSON]
----
{
  id: <identity>,
  name: <string>,
  type: <value>,
  order: <number>,
  title: <boolean>,
  subtitle: <boolean>,
  sort: <sort-order>,
  deleted: <boolean>
}
----

`column` objects appear in `columns` ops, where they specify the attributes of userdata columns.

== Ops

An *op* is a structure that represents an update to the state of a Delectus list. A Delectus list is represented as an append-only time-ordered log of ops. Each type of op performs a different type of update to a list.

An op is represented in a Delectus file as a row in the `listdata` table. The `listdata` table is structured as a time-ordered log of ops. Delectus only appends to the `listdata` table; it never deletes or overwrites existing data. Updating an existing op therefore means adding a new op that supersedes the old one.

This append-only discipline enables Delectus to safely merge data from concurrently-modified copies of a list without losing any data.

== Op structure

=== `sync`

Records that Delectus successfully synchronized the lists's state with a different copy of the list.

[cols="1,2,4",options="header"]
.Op `sync`
|===
| field | permitted values | description
| `type` | `"sync"` | Identifies the type of op.
| `opid` | `_identity_` | Uniquely identifies the op.
| `origin` | `_identity_` | Uniquely identifies the node that created the op.
| `timestamp` | `_timestamp_` | The time that the op was created, as reported by the creating node.
| `peer` | `_identity_` | Uniquely identifies the node from which the sync data was imported.
| `file` | `_identity_` | Uniquely identifies the list file whose data the sync imported.
|===

=== `listname`

[cols="1,2,4",options="header"]
.Op `listname`
|===
| field | permitted values | description
| `type` | `"listname"` | Identifies the type of op.
| `opid` | `_identity_` | Uniquely identifies the op.
| `origin` | `_identity_` | Uniquely identifies the node that created the op.
| `timestamp` | `_timestamp_` | The time that the op was created, as reported by the creating node.
| `name` | `_string_` | The user-assignable name of the list.
|===

=== `columns`

[cols="1,2,4",options="header"]
.Op `columns`
|===
| field | permitted values | description
| `type` | `"columns"` | Identifies the type of op.
| `opid` | `_identity_` | Uniquely identifies the op.
| `origin` | `_identity_` | Uniquely identifies the node that created the op.
| `timestamp` | `_timestamp_` | The time that the op was created, as reported by the creating node.
| `_[identity]+_` | `_column_*` | The list's column attributes.
|===

The notation `_[identity]+_` represents one or more `identity` strings used to identify userdata columns in the list. The value of each `_[identity]+_` field is a `<<column-definition>>` object that specifies the values of the column's attributes.

The `_[identity]+_` string is also used as the label of the SQLite column that stores the attributes and values in the userdata column. Delectus never shows the `_[identity]+_` strings to a user; it instead displays the column's user-assigned `name` attribute.

=== `item`

[cols="1,2,4",options="header"]
.Op `item`
|===
| field | permitted values | description
| `type` | `"item"` | Identifies the type of op.
| `opid` | `_identity_` | Uniquely identifies the op.
| `origin` | `_identity_` | Uniquely identifies the node that created the op.
| `timestamp` | `_timestamp_` | The time that the op was created, as reported by the creating node.
| `item` | `_identity_` | Uniquely identifies the list item.
| `deleted` | `_Boolean_` | Whether the item is marked deleted.
| `_[identity]+_` | `_field_*` | The field values for each column of the item.
|===

The notation `_[identity]+_` represents one or more columns whose labels are `identity` strings. There is one such field in the `item` op for each userdata column in the list. The contents of each one is the value of the corresponding field of the item.

== Tables

== The `delectus` table

The `delectus` table stores data identifying the file, the list, and the Delectus node that created them. It also records the version of the file format used.

== The `listdata` table

The `listdata` table contains the log of ops, and therefore the data and metadata of the list.

It stores metadata in five SQLite columns named `type`, `opid`, `origin`, and `timestamp`, and `metadata`.

It stores userdata in a variable number of columns. Each column's label in the SQLite file is an `identity` string, and its contents is a JSON value.

In `columns` ops, the JSON value in the column is a `column` object that gives the attributes of the column--its user-assigned name and type, whether it has been marked deleted, and a few other attributes. See the <<column-definition>> definition for a full description.

In `item` ops, the JSON value is the user-assigned value in that column of the item.
