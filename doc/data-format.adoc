= Delectus 2 Data Format
:toc:

== Concepts

[cols="1,4",options="header"]
.Concepts used in this manual
|===
| term |  definition
| *list* |  An ordered sequence of *items* containing *values* in *fields* arranged in named *columns*.
| *item* |  An individual entry in a list. An item is an ordered sequence of *fields*. A list may contain multiple *versions* of a given item.
| *field* |  A container for *values*. Each field occupies exactly one *column* of one *item*. A field may be empty, or it may contain a *value*.
| *value* |  Either `null`, or a `Boolean`, `number`, or `string` object.
| *column* |  A named container for *fields*. The fields of an *item* are ordered. Every item in a given *list* has the same number of fields. All of the fields in a given position occupy the same column. The first column of a list contains the first field of each item; the second column contains the second field of each item; and so on.
| *op* |  A data structure that represents an edit to a list. A Delectus list is conceptually a time-ordered, append-only log of ops.
|===
== Ops

There are five types of op:

. `listname` ops define or update the user-assigned name of the list.
. `comment` ops define or update the user-assigned comment field of the list.
. `columns` ops define or update the *userdata* columns of the list.
. `item` ops insert, update, or delete individual items in the list.
. `sync` ops record a successful synchronization between two copies of a list.

=== Op structure

Each op is stored as a row in a SQLite table. Each type of op gets its own table.

A total ordering of ops in a list file is maintained using revision counts. Each time an op is added to any table, it's given a revision number. Each time a revision number is assigned, the file's revision count is incremented.

It's possible for two or more ops to have the same revision number if they were created in different copies of the list and then merged by a sync. In that case, they are ordered by their `opid`. The `opid` is random, and so the order will be arbitrary, but it will be the same across merged copies, and so will preserve consistency.

A total ordering of items is maintained in the same way, but with some additional requirements. A user may update an item, which inserts a new version. The new op, like all ops, has a unique id, but Delectus requires a way to know that the new op represents a new version of an existing item, rather than an entirely new item. Each `item` op therefore carries an `itemid` in addition to the `opid`.

When Delectus presents the list's items, it shows only the latest versions. All the ops with a given `itemid` are grouped together and sorted by revision number and then opid, just as in the case of other ops. Only the latest op is then shown for each item.

==== listname

[cols="1,2,4",options="header"]
.Structure of the `listnames` op
|===
| field | type | description
| `opid` | `BLOB` | The `identity` of the op.
| `revision` | `INTEGER` | The revision number of the op.
| `timestamp` | `INTEGER` | The time that the op was created, as reported by the creating node.
| `name` | `TEXT` | The new name of the list.
|===

==== comment

[cols="1,2,4",options="header"]
.Structure of the `comments` op
|===
| field | type | description
| `opid` | `BLOB` | The `identity` of the op.
| `revision` | `INTEGER` | The revision number of the op.
| `timestamp` | `INTEGER` | The time that the op was created, as reported by the creating node.
| `comment` | `TEXT` | The new comment of the list.
|===

==== columns

[cols="1,2,4",options="header"]
.Structure of the `'columns'` op
|===
| field | type | description
| `opid` | `BLOB` | The `identity` of the op.
| `revision` | `INTEGER` | The revision number of the op.
| `timestamp` | `INTEGER` | The time that the op was created, as reported by the creating node.
| `_[label]_+` | `column` | A `column` objects defining the attributes of the column.
|===

The significance of the notation `_[label]_+` is that a `columns` op may have any number of these `_[label]_+` fields, each one defining the attributes of one column.

==== item

[cols="1,2,4",options="header"]
.Structure of the `'item'` op
|===
| field | type | description
| `opid` | `BLOB` | The `identity` of the op.
| `revision` | `INTEGER` | The revision number of the op.
| `timestamp` | `INTEGER` | The time that the op was created, as reported by the creating node.
| `itemid` | `BLOB` | The `identity` if the item.
| `deleted` | `INTEGER` | A Boolean value: `true` if the item has been marked deleted, `false` or `null` otherwise.
| `_[label]_+` | `value` | A JSON value defining the value of the field in this column.
|===

The significance of the notation `_[label]_+` is that an `item` op may have any number of these `_[label]_+` fields, each one defining the value of one field.

==== sync

[cols="1,2,4",options="header"]
.Structure of the `sync` op
|===
| field | type | description
| `opid` | `BLOB` | The `identity` of the op.
| `revision` | `INTEGER` | The revision number of the op.
| `timestamp` | `INTEGER` | The time that the op was created, as reported by the creating node.
| `local_node` | `BLOB` | The `identity` of this Delectus node.
| `remote_node` | `BLOB` | The `identity` of the Delectus node we synced with.
| `listid` | `BLOB` | The `identity` of the Delectus list we synced.
|===
