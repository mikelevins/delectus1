= Delectus 2 Storage in SQLite Files

Delectus 2 stores *lists* in SQLite files, one list per file. This document explains how Delectus organizes and stores list data in SQLite databases.

== Ops

=== Overview

Delectus stores list data as an append-only log of *ops*. An *op* is a tuple of values in a specified format that represents both an instruction to update the state of a list, and a concrete representation of the list's new state. A Delectus file is a log of ops, plus some metadata that identifies the individual list and the version of the file format.

=== Op format

There are four kinds of ops:

. `*listname:*` Assert the name of the list
. `*columns:*` Assert the lit's columns
. `*item:*` Assert an item in the list
. `*sync:*` Assert that we successfully synced with another device's copy of the list

All four op type share a common format, shown here:

[cols="1,1,3", options="header"]
.The *op* data format
|===
|field | type | description

|`*optype*` | `text` | The type of this op.
|`*opid*` | `opid` | The unique ID of this op.
|`*origin*` | `opid` | The device where this op originated.
|`*revision*` | `integer` | The revision number of this op.
|`*item*` | `opid` | In `item`, the unique ID of this item.
|`*name*` | `text` | In `listname`, the new name of this list.
|`*deleted*` | `boolean` | In `item`, whether this item is deleted.
|`*peer*` | `opid` | In `sync`, the remote device with which we synced.
|`*columnid**` | `[columnid]*` | Zero or more `column` objects. The number of `columnid` objects is equal to the number of columns in this list. In `columns`, each is a JSON object giving the attributes of one column. In `item`, each is a value, giving the value of the field in each column.

|===

Not all ops use all  fields. In fact, the only fields used by all ops are `optype`, `opid`, `origin`, and `revision`. All ops use the same data format, though, so that all can be asserted into the same SQLite table.

*_columnid*_* here stands for any number of *userdata colums*. A user may create a new data column at any time. That column's label is a text string in `*columnid*` format. Users normally never see the `columnid` string; instead, they see only the `name` and other attributes of the column's `*columndata*` attributes.

=== Format of data within ops

This section describes the details of the data stored in the fields of an op.

==== Op field types

The data types used in the fields of an op are defined as follows:

[cols="1,3", options="header"]
.*op* field types
|===
|type name | description

|`text`
|A text string

|`opid`
|A garden-variety UUID string. Delectus uses *time-first UUIDs*.

|`boolean`
|`true` or `false`

|`columndata`
|A JSON string representing a `columndata` object. See the "columndata" section below.

|`fielddata`
|A `null`, `boolean`, `number`, or `text` object.

|===

==== columndata

A `*columndata*` object is a JSON object that represents the attributes of a *userdata column*. The `columndata` object is defined as follows:

[cols="1,1,3", options="header"]
.The `*columdata*` object
|===
|attribute |type |description

|`id`
|`columnid`
|The column's unique ID

|`name`
|`string`
|The user-defined name of the column; unique in a given list

|`type`
|`boolean`, `number`, or `text`
|Used by Delectus to control sorting and presentation

|`order`
|`double`
| User-defined order of appearance in the Delectus application; unique in a given list

|`sort`
|`null` or one of the strings `asc` or `desc`
|Whether the list's items are sorted on this column (`null` if not), and in which direction (`asc` or `desc`). Exactly one column in a list is the sort column.

|`title`
|`boolean`
|Whether this column is used as the *title field* of the item in the Delectus UI, Exactly one column in a list is the title column.

|`subtitle`
|`boolean`
|Whether this column is used as the *subtitle field* of the item in the Delectus UI. At most one column in a list is the subtitle column.

|`deleted`
|`boolean`
|Whether this column is marked deleted.

|===


==== columnid

[cols="1,3", options="header"]
.*The `columnid` type
|===
|type name | description

|`columnid`
|A text string of the form `"Cxxxxxxxxxxxxxxxx"`. The characters after the 'C' are the text of a *time-first UUID string*, but with hyphens removed.

Delectus uses this format so that `columnid` values may be used without escaping to label the SQLite columns that represent Delectus columns.

|===


=== Defined  Delectus ops

Delectus defines four types of ops:

. `*listname*` asserts the name of the current list
. `*columns*` asserts the current values of all column attributes
. `*item*` asserts the vaules of all fields of a specified list item
. `*sync*` asserts that a successful *sync* operation was performed

This section describes each of these ops in greater detail.

==== listname
===== *listname* _opid_ _origin_ _name_ _revision_

Asserts the name of the list. The current name of the list is the value of the `name` field in the latest `listname` op. The first op in any Delectus list is `listname`.


[cols="1,1,3", options="header"]
|===
|field | value | comments

|`*optype*` | `"listname"` | this literal string
|`*opid*` | `_opid_` | this op's unique ID
|`*origin*` | `_opid_` | this device where this op originated
|`*revision*` | `integer` | this op's revision number
|`item` | `null` | unused
|`*name*` | `_text_` | the list's new name
|`deleted` | `null` | unused
|`peer` | `null` | unused
|`columnid*` | `[null]*` | unused

|===


==== columns
===== *columns* _opid_ _origin_ _revision_ [_columnid_]*

Asserts the list's current columns and their attributes. There may be any number of _columnid_ parameters, but their number and attributes must match the state of the Delectus file after the op is asserted. Delectus checks the _columnid_ parameters before asserting the op into its log. If there are fewer columns in the op than in the list file, or if there are other inconsistencies that prevent Delectus from updating the file to reflect the _columnid_ parameters in the op, then Delectus signals an error and rejects the op without changing the file.


[cols="1,1,3", options="header"]
|===
|field | value | comments

|`*optype*` | `"columns"` | this literal string
|`*opid*` | `_opid_` | this op's unique ID
|`*origin*` | `_opid_` | this device where this op originated
|`*revision*` | `integer` | this op's revision number
|`item` | `null` | unused
|`name` | `null` | unused
|`deleted` | `null` | unused
|`peer` | `null` | unused
|`*columnid**` | `[columndata]*` | column attributes for each column, as JSON strings (see `columndata`, above)

|===


==== item
===== *item* _opid_ _origin_ _item_ _deleted_ _revision_ [_columnvalue_]*

Asserts an item into the list. If the _item_ ID is equal to any existing _item_ ID in the list, then this op becomes the new value of that item, superseding the value of the previous one. If there is no existing item with this _item_ ID, then this op is a new item in the list.


[cols="1,1,3", options="header"]
|===
|field | value | comments

|`*optype*` | `"item"` | this literal string
|`*opid*` | `_opid_` | this op's unique ID
|`*origin*` | `_opid_` | this device where this op originated
|`*revision*` | `integer` | this op's revision number
|`*item*` | `opid` | The unique ID of this item
|`name` | `null` | unused
|`*deleted*` | `boolean` | Whether this item is marked deleted
|`peer` | `null` | unused
|`*columnid**` | `[fielddata]*` | item's field values, one for each column

|===

==== sync
===== *sync* _opid_ _origin_ _peer_ _revision_

Asserts an item into the list. If the _item_ ID is equal to any existing _item_ ID in the list, then this op becomes the new value of that item, superseding the value of the previous one. If there is no existing item with this _item_ ID, then this op is a new item in the list.


[cols="1,1,3", options="header"]
|===
|field | value | comments

|`*optype*` | `"sync"` | this literal string
|`*opid*` | `_opid_` | this op's unique ID
|`*origin*` | `_opid_` | this device where this op originated
|`*revision*` | `integer` | this op's revision number
|`item` | `null` | unused
|`name` | `null` | unused
|`deleted` | `null` | unused
|`*peer*` | `opid` | the remote device with which we synced
|`columnid*` | `[null]*` | unused

|===


== SQLite tables

A Delectus data file is a SQLite 3 file that contains two tables:

. The `*delectus*` table stores the unique ID of the list, and the current version of the delectus file format.
. The `*list_data*` table stores the list's data as an append-only log of Delectus ops, as explained in the "Ops" section, above.


=== The `*delectus*` table
=== The `*list_data*` table
