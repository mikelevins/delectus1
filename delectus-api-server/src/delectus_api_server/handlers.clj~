(ns delectus-api-server.handlers
  (:require
   [buddy.auth :refer [authenticated? throw-unauthorized]]
   [buddy.auth.backends :as backends]
   [buddy.auth.middleware :refer [wrap-authentication wrap-authorization]]
   [buddy.sign.jwt :as jwt]
   [clj-time.core :as time]
   [clojure.data.json :as json]
   [clojure.java.io :as io]
   [compojure.core :refer :all]
   [compojure.response :refer [render]]
   [compojure.route :as route]
   [delectus-api-server.configuration :as config]
   [delectus-api-server.couchbase.delectus.users :as delectus-users]
   [delectus-api-server.couchbase.marshal :as marshal]
   [org.httpkit.server :as server]
   [ring.middleware.cors :refer [wrap-cors]]
   [ring.middleware.defaults :refer :all]
   [ring.middleware.params :refer [wrap-params]]
   [ring.middleware.session :refer [wrap-session]]
   [ring.util.response :refer [response redirect content-type]]))


;;; ---------------------------------------------------------------------
;;; generic test handlers
;;; ---------------------------------------------------------------------

(defn echo [req]
  {:status  200
   :headers {"Content-Type" "application/json"}
   :body    (json/write-str (marshal/make-couchable req))})


(defn status [req]
  {:status 200
   :headers {"Content-type" "application/json"}
   :body (let [mgr (.clusterManager (config/couchbase-cluster)
                                    (:delectus-admin-user (config/delectus-configuration))
                                    (:delectus-admin-password (config/delectus-configuration)))
               info (.raw (.info mgr))]
           (.toString info))})

;;; ---------------------------------------------------------------------
;;; support functions
;;; ---------------------------------------------------------------------

(defn login-user [email password]
  (let [found-user (users/user-from-email email)]
    (if found-user
      (if (hashers/check password (:password-hash found-user))
        found-user
        false)
      false)))

;;; (login-user "mikel@evins.net" "")

;;; ---------------------------------------------------------------------
;;; delectus handlers
;;; ---------------------------------------------------------------------

(defn login [req]
  (let [params (:params req)
        supplied-email (:email params)
        supplied-password (:password params)
        found-user (login-user supplied-email supplied-password)]
    (if found-user
      {:status  200
       :headers {"Content-Type" "application/json"}
       :body (let [secret (config/delectus-users-signing-secret)
                   claims {:user (:email found-user)
                           :exp (time/plus (time/now) (time/seconds 3600))}
                   token (jwt/sign claims secret)]
               (json/write-str {:token token}))}
      {:status  401
       :headers {"Content-Type" "text/html"}
       :body    (html [:h1 "Delectus 2"]
                      [:p "Login failed"])})))


(defn userid [request]
  (if-not (authenticated? request)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params request))]
                (json/write-str (api/email->user-id email)))}))

(defn collections [req]
  (if-not (authenticated? req)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params req))]
                (json/write-str (api/list-collections (api/email->user-id email))))}))

(defn lists [req]
  (if-not (authenticated? req)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params req))]
                (json/write-str (api/list-lists (api/email->user-id email))))}))

(defn collection-with-id [req]
  (if-not (authenticated? req)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params req))
                    collection-id (:id (:params req))]
                (json/write-str (api/find-collection-by-id (api/email->user-id email)
                                                           collection-id)))}))

(defn collection-named [req]
  (if-not (authenticated? req)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params req))
                    collection-name (:name (:params req))]
                (json/write-str (api/find-collection-by-name (api/email->user-id email)
                                                             collection-name)))}))

(defn list-with-id [req]
  (if-not (authenticated? req)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params req))
                    list-id (:id (:params req))]
                (json/write-str (api/find-list-by-id (api/email->user-id email)
                                                     list-id)))}))

(defn list-named [req]
  (if-not (authenticated? req)
    (throw-unauthorized)
    {:status  200
     :headers {"Content-Type" "application/json"}
     :body    (let [email (:email (:params req))
                    list-name (:name (:params req))]
                (json/write-str (api/find-list-by-name (api/email->user-id email)
                                                       list-name)))}))

